function [] = optimizeUndist(regs)
% Finds an optimal lut configuration so the error caused by bug will be
% fixed.

maxAng = 2047;
[angx,angy] = meshgrid(linspace(-maxAng,maxAng,10),linspace(-maxAng,maxAng,10));


[~,~,xyStruct.source.x,xyStruct.source.y]  = Pipe.DIGG.ang2xy(angx,angy,regs,[],[]); % Ang2xy from Pipe
[xyStruct.target.x, xyStruct.target.y] = localAng2xy(angx,angy,regs,true);

% Initial LUT doesn't move any pixel
xLUT = [-2097152,-1285351,-473550,338250,1150051,1961852,2773653,3585454,4397254,5209055,6020856,6832657,7644458,8456258,9268059,10079860,10891660,11703461,12515262,13327063,14138863,14950664,15762465,16574266,17386066,18197868,19009668,19821468,20633270,21445070,22256872,23068672;-2097152,-1285351,-473550,338250,1150051,1961852,2773653,3585454,4397254,5209055,6020856,6832657,7644458,8456258,9268059,10079860,10891660,11703461,12515262,13327063,14138863,14950664,15762465,16574266,17386066,18197868,19009668,19821468,20633270,21445070,22256872,23068672;-2097152,-1285351,-473550,338250,1150051,1961852,2773653,3585454,4397254,5209055,6020856,6832657,7644458,8456258,9268059,10079860,10891660,11703461,12515262,13327063,14138863,14950664,15762465,16574266,17386066,18197868,19009668,19821468,20633270,21445070,22256872,23068672;-2097152,-1285351,-473550,338250,1150051,1961852,2773653,3585454,4397254,5209055,6020856,6832657,7644458,8456258,9268059,10079860,10891660,11703461,12515262,13327063,14138863,14950664,15762465,16574266,17386066,18197868,19009668,19821468,20633270,21445070,22256872,23068672;-2097152,-1285351,-473550,338250,1150051,1961852,2773653,3585454,4397254,5209055,6020856,6832657,7644458,8456258,9268059,10079860,10891660,11703461,12515262,13327063,14138863,14950664,15762465,16574266,17386066,18197868,19009668,19821468,20633270,21445070,22256872,23068672;-2097152,-1285351,-473550,338250,1150051,1961852,2773653,3585454,4397254,5209055,6020856,6832657,7644458,8456258,9268059,10079860,10891660,11703461,12515262,13327063,14138863,14950664,15762465,16574266,17386066,18197868,19009668,19821468,20633270,21445070,22256872,23068672;-2097152,-1285351,-473550,338250,1150051,1961852,2773653,3585454,4397254,5209055,6020856,6832657,7644458,8456258,9268059,10079860,10891660,11703461,12515262,13327063,14138863,14950664,15762465,16574266,17386066,18197868,19009668,19821468,20633270,21445070,22256872,23068672;-2097152,-1285351,-473550,338250,1150051,1961852,2773653,3585454,4397254,5209055,6020856,6832657,7644458,8456258,9268059,10079860,10891660,11703461,12515262,13327063,14138863,14950664,15762465,16574266,17386066,18197868,19009668,19821468,20633270,21445070,22256872,23068672;-2097152,-1285351,-473550,338250,1150051,1961852,2773653,3585454,4397254,5209055,6020856,6832657,7644458,8456258,9268059,10079860,10891660,11703461,12515262,13327063,14138863,14950664,15762465,16574266,17386066,18197868,19009668,19821468,20633270,21445070,22256872,23068672;-2097152,-1285351,-473550,338250,1150051,1961852,2773653,3585454,4397254,5209055,6020856,6832657,7644458,8456258,9268059,10079860,10891660,11703461,12515262,13327063,14138863,14950664,15762465,16574266,17386066,18197868,19009668,19821468,20633270,21445070,22256872,23068672;-2097152,-1285351,-473550,338250,1150051,1961852,2773653,3585454,4397254,5209055,6020856,6832657,7644458,8456258,9268059,10079860,10891660,11703461,12515262,13327063,14138863,14950664,15762465,16574266,17386066,18197868,19009668,19821468,20633270,21445070,22256872,23068672;-2097152,-1285351,-473550,338250,1150051,1961852,2773653,3585454,4397254,5209055,6020856,6832657,7644458,8456258,9268059,10079860,10891660,11703461,12515262,13327063,14138863,14950664,15762465,16574266,17386066,18197868,19009668,19821468,20633270,21445070,22256872,23068672;-2097152,-1285351,-473550,338250,1150051,1961852,2773653,3585454,4397254,5209055,6020856,6832657,7644458,8456258,9268059,10079860,10891660,11703461,12515262,13327063,14138863,14950664,15762465,16574266,17386066,18197868,19009668,19821468,20633270,21445070,22256872,23068672;-2097152,-1285351,-473550,338250,1150051,1961852,2773653,3585454,4397254,5209055,6020856,6832657,7644458,8456258,9268059,10079860,10891660,11703461,12515262,13327063,14138863,14950664,15762465,16574266,17386066,18197868,19009668,19821468,20633270,21445070,22256872,23068672;-2097152,-1285351,-473550,338250,1150051,1961852,2773653,3585454,4397254,5209055,6020856,6832657,7644458,8456258,9268059,10079860,10891660,11703461,12515262,13327063,14138863,14950664,15762465,16574266,17386066,18197868,19009668,19821468,20633270,21445070,22256872,23068672;-2097152,-1285351,-473550,338250,1150051,1961852,2773653,3585454,4397254,5209055,6020856,6832657,7644458,8456258,9268059,10079860,10891660,11703461,12515262,13327063,14138863,14950664,15762465,16574266,17386066,18197868,19009668,19821468,20633270,21445070,22256872,23068672;-2097152,-1285351,-473550,338250,1150051,1961852,2773653,3585454,4397254,5209055,6020856,6832657,7644458,8456258,9268059,10079860,10891660,11703461,12515262,13327063,14138863,14950664,15762465,16574266,17386066,18197868,19009668,19821468,20633270,21445070,22256872,23068672;-2097152,-1285351,-473550,338250,1150051,1961852,2773653,3585454,4397254,5209055,6020856,6832657,7644458,8456258,9268059,10079860,10891660,11703461,12515262,13327063,14138863,14950664,15762465,16574266,17386066,18197868,19009668,19821468,20633270,21445070,22256872,23068672;-2097152,-1285351,-473550,338250,1150051,1961852,2773653,3585454,4397254,5209055,6020856,6832657,7644458,8456258,9268059,10079860,10891660,11703461,12515262,13327063,14138863,14950664,15762465,16574266,17386066,18197868,19009668,19821468,20633270,21445070,22256872,23068672;-2097152,-1285351,-473550,338250,1150051,1961852,2773653,3585454,4397254,5209055,6020856,6832657,7644458,8456258,9268059,10079860,10891660,11703461,12515262,13327063,14138863,14950664,15762465,16574266,17386066,18197868,19009668,19821468,20633270,21445070,22256872,23068672;-2097152,-1285351,-473550,338250,1150051,1961852,2773653,3585454,4397254,5209055,6020856,6832657,7644458,8456258,9268059,10079860,10891660,11703461,12515262,13327063,14138863,14950664,15762465,16574266,17386066,18197868,19009668,19821468,20633270,21445070,22256872,23068672;-2097152,-1285351,-473550,338250,1150051,1961852,2773653,3585454,4397254,5209055,6020856,6832657,7644458,8456258,9268059,10079860,10891660,11703461,12515262,13327063,14138863,14950664,15762465,16574266,17386066,18197868,19009668,19821468,20633270,21445070,22256872,23068672;-2097152,-1285351,-473550,338250,1150051,1961852,2773653,3585454,4397254,5209055,6020856,6832657,7644458,8456258,9268059,10079860,10891660,11703461,12515262,13327063,14138863,14950664,15762465,16574266,17386066,18197868,19009668,19821468,20633270,21445070,22256872,23068672;-2097152,-1285351,-473550,338250,1150051,1961852,2773653,3585454,4397254,5209055,6020856,6832657,7644458,8456258,9268059,10079860,10891660,11703461,12515262,13327063,14138863,14950664,15762465,16574266,17386066,18197868,19009668,19821468,20633270,21445070,22256872,23068672;-2097152,-1285351,-473550,338250,1150051,1961852,2773653,3585454,4397254,5209055,6020856,6832657,7644458,8456258,9268059,10079860,10891660,11703461,12515262,13327063,14138863,14950664,15762465,16574266,17386066,18197868,19009668,19821468,20633270,21445070,22256872,23068672;-2097152,-1285351,-473550,338250,1150051,1961852,2773653,3585454,4397254,5209055,6020856,6832657,7644458,8456258,9268059,10079860,10891660,11703461,12515262,13327063,14138863,14950664,15762465,16574266,17386066,18197868,19009668,19821468,20633270,21445070,22256872,23068672;-2097152,-1285351,-473550,338250,1150051,1961852,2773653,3585454,4397254,5209055,6020856,6832657,7644458,8456258,9268059,10079860,10891660,11703461,12515262,13327063,14138863,14950664,15762465,16574266,17386066,18197868,19009668,19821468,20633270,21445070,22256872,23068672;-2097152,-1285351,-473550,338250,1150051,1961852,2773653,3585454,4397254,5209055,6020856,6832657,7644458,8456258,9268059,10079860,10891660,11703461,12515262,13327063,14138863,14950664,15762465,16574266,17386066,18197868,19009668,19821468,20633270,21445070,22256872,23068672;-2097152,-1285351,-473550,338250,1150051,1961852,2773653,3585454,4397254,5209055,6020856,6832657,7644458,8456258,9268059,10079860,10891660,11703461,12515262,13327063,14138863,14950664,15762465,16574266,17386066,18197868,19009668,19821468,20633270,21445070,22256872,23068672;-2097152,-1285351,-473550,338250,1150051,1961852,2773653,3585454,4397254,5209055,6020856,6832657,7644458,8456258,9268059,10079860,10891660,11703461,12515262,13327063,14138863,14950664,15762465,16574266,17386066,18197868,19009668,19821468,20633270,21445070,22256872,23068672;-2097152,-1285351,-473550,338250,1150051,1961852,2773653,3585454,4397254,5209055,6020856,6832657,7644458,8456258,9268059,10079860,10891660,11703461,12515262,13327063,14138863,14950664,15762465,16574266,17386066,18197868,19009668,19821468,20633270,21445070,22256872,23068672;-2097152,-1285351,-473550,338250,1150051,1961852,2773653,3585454,4397254,5209055,6020856,6832657,7644458,8456258,9268059,10079860,10891660,11703461,12515262,13327063,14138863,14950664,15762465,16574266,17386066,18197868,19009668,19821468,20633270,21445070,22256872,23068672];
yLUT = [-1572864,-1572864,-1572864,-1572864,-1572864,-1572864,-1572864,-1572864,-1572864,-1572864,-1572864,-1572864,-1572864,-1572864,-1572864,-1572864,-1572864,-1572864,-1572864,-1572864,-1572864,-1572864,-1572864,-1572864,-1572864,-1572864,-1572864,-1572864,-1572864,-1572864,-1572864,-1572864;-964013,-964013,-964013,-964013,-964013,-964013,-964013,-964013,-964013,-964013,-964013,-964013,-964013,-964013,-964013,-964013,-964013,-964013,-964013,-964013,-964013,-964013,-964013,-964013,-964013,-964013,-964013,-964013,-964013,-964013,-964013,-964013;-355163,-355163,-355163,-355163,-355163,-355163,-355163,-355163,-355163,-355163,-355163,-355163,-355163,-355163,-355163,-355163,-355163,-355163,-355163,-355163,-355163,-355163,-355163,-355163,-355163,-355163,-355163,-355163,-355163,-355163,-355163,-355163;253688,253688,253688,253688,253688,253688,253688,253688,253688,253688,253688,253688,253688,253688,253688,253688,253688,253688,253688,253688,253688,253688,253688,253688,253688,253688,253688,253688,253688,253688,253688,253688;862538,862538,862538,862538,862538,862538,862538,862538,862538,862538,862538,862538,862538,862538,862538,862538,862538,862538,862538,862538,862538,862538,862538,862538,862538,862538,862538,862538,862538,862538,862538,862538;1471389,1471389,1471389,1471389,1471389,1471389,1471389,1471389,1471389,1471389,1471389,1471389,1471389,1471389,1471389,1471389,1471389,1471389,1471389,1471389,1471389,1471389,1471389,1471389,1471389,1471389,1471389,1471389,1471389,1471389,1471389,1471389;2080240,2080240,2080240,2080240,2080240,2080240,2080240,2080240,2080240,2080240,2080240,2080240,2080240,2080240,2080240,2080240,2080240,2080240,2080240,2080240,2080240,2080240,2080240,2080240,2080240,2080240,2080240,2080240,2080240,2080240,2080240,2080240;2689090,2689090,2689090,2689090,2689090,2689090,2689090,2689090,2689090,2689090,2689090,2689090,2689090,2689090,2689090,2689090,2689090,2689090,2689090,2689090,2689090,2689090,2689090,2689090,2689090,2689090,2689090,2689090,2689090,2689090,2689090,2689090;3297941,3297941,3297941,3297941,3297941,3297941,3297941,3297941,3297941,3297941,3297941,3297941,3297941,3297941,3297941,3297941,3297941,3297941,3297941,3297941,3297941,3297941,3297941,3297941,3297941,3297941,3297941,3297941,3297941,3297941,3297941,3297941;3906791,3906791,3906791,3906791,3906791,3906791,3906791,3906791,3906791,3906791,3906791,3906791,3906791,3906791,3906791,3906791,3906791,3906791,3906791,3906791,3906791,3906791,3906791,3906791,3906791,3906791,3906791,3906791,3906791,3906791,3906791,3906791;4515642,4515642,4515642,4515642,4515642,4515642,4515642,4515642,4515642,4515642,4515642,4515642,4515642,4515642,4515642,4515642,4515642,4515642,4515642,4515642,4515642,4515642,4515642,4515642,4515642,4515642,4515642,4515642,4515642,4515642,4515642,4515642;5124493,5124493,5124493,5124493,5124493,5124493,5124493,5124493,5124493,5124493,5124493,5124493,5124493,5124493,5124493,5124493,5124493,5124493,5124493,5124493,5124493,5124493,5124493,5124493,5124493,5124493,5124493,5124493,5124493,5124493,5124493,5124493;5733343,5733343,5733343,5733343,5733343,5733343,5733343,5733343,5733343,5733343,5733343,5733343,5733343,5733343,5733343,5733343,5733343,5733343,5733343,5733343,5733343,5733343,5733343,5733343,5733343,5733343,5733343,5733343,5733343,5733343,5733343,5733343;6342194,6342194,6342194,6342194,6342194,6342194,6342194,6342194,6342194,6342194,6342194,6342194,6342194,6342194,6342194,6342194,6342194,6342194,6342194,6342194,6342194,6342194,6342194,6342194,6342194,6342194,6342194,6342194,6342194,6342194,6342194,6342194;6951044,6951044,6951044,6951044,6951044,6951044,6951044,6951044,6951044,6951044,6951044,6951044,6951044,6951044,6951044,6951044,6951044,6951044,6951044,6951044,6951044,6951044,6951044,6951044,6951044,6951044,6951044,6951044,6951044,6951044,6951044,6951044;7559895,7559895,7559895,7559895,7559895,7559895,7559895,7559895,7559895,7559895,7559895,7559895,7559895,7559895,7559895,7559895,7559895,7559895,7559895,7559895,7559895,7559895,7559895,7559895,7559895,7559895,7559895,7559895,7559895,7559895,7559895,7559895;8168746,8168746,8168746,8168746,8168746,8168746,8168746,8168746,8168746,8168746,8168746,8168746,8168746,8168746,8168746,8168746,8168746,8168746,8168746,8168746,8168746,8168746,8168746,8168746,8168746,8168746,8168746,8168746,8168746,8168746,8168746,8168746;8777596,8777596,8777596,8777596,8777596,8777596,8777596,8777596,8777596,8777596,8777596,8777596,8777596,8777596,8777596,8777596,8777596,8777596,8777596,8777596,8777596,8777596,8777596,8777596,8777596,8777596,8777596,8777596,8777596,8777596,8777596,8777596;9386446,9386446,9386446,9386446,9386446,9386446,9386446,9386446,9386446,9386446,9386446,9386446,9386446,9386446,9386446,9386446,9386446,9386446,9386446,9386446,9386446,9386446,9386446,9386446,9386446,9386446,9386446,9386446,9386446,9386446,9386446,9386446;9995297,9995297,9995297,9995297,9995297,9995297,9995297,9995297,9995297,9995297,9995297,9995297,9995297,9995297,9995297,9995297,9995297,9995297,9995297,9995297,9995297,9995297,9995297,9995297,9995297,9995297,9995297,9995297,9995297,9995297,9995297,9995297;10604148,10604148,10604148,10604148,10604148,10604148,10604148,10604148,10604148,10604148,10604148,10604148,10604148,10604148,10604148,10604148,10604148,10604148,10604148,10604148,10604148,10604148,10604148,10604148,10604148,10604148,10604148,10604148,10604148,10604148,10604148,10604148;11212998,11212998,11212998,11212998,11212998,11212998,11212998,11212998,11212998,11212998,11212998,11212998,11212998,11212998,11212998,11212998,11212998,11212998,11212998,11212998,11212998,11212998,11212998,11212998,11212998,11212998,11212998,11212998,11212998,11212998,11212998,11212998;11821849,11821849,11821849,11821849,11821849,11821849,11821849,11821849,11821849,11821849,11821849,11821849,11821849,11821849,11821849,11821849,11821849,11821849,11821849,11821849,11821849,11821849,11821849,11821849,11821849,11821849,11821849,11821849,11821849,11821849,11821849,11821849;12430699,12430699,12430699,12430699,12430699,12430699,12430699,12430699,12430699,12430699,12430699,12430699,12430699,12430699,12430699,12430699,12430699,12430699,12430699,12430699,12430699,12430699,12430699,12430699,12430699,12430699,12430699,12430699,12430699,12430699,12430699,12430699;13039550,13039550,13039550,13039550,13039550,13039550,13039550,13039550,13039550,13039550,13039550,13039550,13039550,13039550,13039550,13039550,13039550,13039550,13039550,13039550,13039550,13039550,13039550,13039550,13039550,13039550,13039550,13039550,13039550,13039550,13039550,13039550;13648401,13648401,13648401,13648401,13648401,13648401,13648401,13648401,13648401,13648401,13648401,13648401,13648401,13648401,13648401,13648401,13648401,13648401,13648401,13648401,13648401,13648401,13648401,13648401,13648401,13648401,13648401,13648401,13648401,13648401,13648401,13648401;14257251,14257251,14257251,14257251,14257251,14257251,14257251,14257251,14257251,14257251,14257251,14257251,14257251,14257251,14257251,14257251,14257251,14257251,14257251,14257251,14257251,14257251,14257251,14257251,14257251,14257251,14257251,14257251,14257251,14257251,14257251,14257251;14866102,14866102,14866102,14866102,14866102,14866102,14866102,14866102,14866102,14866102,14866102,14866102,14866102,14866102,14866102,14866102,14866102,14866102,14866102,14866102,14866102,14866102,14866102,14866102,14866102,14866102,14866102,14866102,14866102,14866102,14866102,14866102;15474952,15474952,15474952,15474952,15474952,15474952,15474952,15474952,15474952,15474952,15474952,15474952,15474952,15474952,15474952,15474952,15474952,15474952,15474952,15474952,15474952,15474952,15474952,15474952,15474952,15474952,15474952,15474952,15474952,15474952,15474952,15474952;16083803,16083803,16083803,16083803,16083803,16083803,16083803,16083803,16083803,16083803,16083803,16083803,16083803,16083803,16083803,16083803,16083803,16083803,16083803,16083803,16083803,16083803,16083803,16083803,16083803,16083803,16083803,16083803,16083803,16083803,16083803,16083803;16692653,16692653,16692653,16692653,16692653,16692653,16692653,16692653,16692653,16692653,16692653,16692653,16692653,16692653,16692653,16692653,16692653,16692653,16692653,16692653,16692653,16692653,16692653,16692653,16692653,16692653,16692653,16692653,16692653,16692653,16692653,16692653;17301504,17301504,17301504,17301504,17301504,17301504,17301504,17301504,17301504,17301504,17301504,17301504,17301504,17301504,17301504,17301504,17301504,17301504,17301504,17301504,17301504,17301504,17301504,17301504,17301504,17301504,17301504,17301504,17301504,17301504,17301504,17301504];
x0 =[xLUT,yLUT];   
[xbest,outputErr]=fminunc(@(x) errFunc(regs,x,xyStruct),x0);

[xnew,ynew] = applyLut(x,y,xLUT,yLUT,regs);
% 
% figure
% plot(x(:),y(:),'*');
% hold on
% plot(single(xnew(:)),single(ynew(:)),'*');
% rectangle('position',[0 0 double(regs.GNRL.imgHsize-1) double(regs.GNRL.imgVsize-1)])
% figure
% imagesc(y-single(ynew)),colorbar


end

function xnew = myCubic(x,y,xLUT,regs)
margin = 1.2;
shift = single(regs.DIGG.bitshift);
fx = single(regs.DIGG.undistFx)/2^shift;
fy = single(regs.DIGG.undistFy)/2^shift;
x0 = single(regs.DIGG.undistX0)/2^shift;
y0 = single(regs.DIGG.undistY0)/2^shift;

XX = x(:) - x0;
YY = y(:) - y0;

xaddr = XX*fx;
yaddr = YY*fy;

[mgx mgy] = meshgrid(0:31,0:31);
B= interp2(mgx, mgy, xLUT, xaddr, yaddr, 'cubic');


end
function e = errFunc(regs,x,xyStruct)
xLUT = x(:,1:32);
yLUT = x(:,33:end);
[xnew,ynew] = applyLut(xyStruct.source.x, xyStruct.source.y ,xLUT,yLUT,regs);
xnew = single(xnew); ynew = single(ynew);
eMat = vec((xnew-xyStruct.target.x).^2 + (ynew-xyStruct.target.y).^2);
relevance = and(and(and(xyStruct.target.x(:)>=0,xyStruct.target.x(:)<=regs.FRMW.xres), xyStruct.target.y(:)>=0), xyStruct.target.y(:)<=regs.FRMW.yres);
e = double(mean(eMat(logical(relevance))));
fprintf('Errror is: %f\n',e);
end
function [xnew,ynew] = applyLut(xold,yold,xLUT,yLUT,regs)



shift = double(regs.DIGG.bitshift);
yold=yold*2^shift;
xold=xold*2^shift;
% shift + scale in
xx = int32(bitshift(int64(xold).*int64(regs.DIGG.xScaleIn),-shift)) + regs.DIGG.xShiftIn;
yy = int32(bitshift(int64(yold).*int64(regs.DIGG.yScaleIn),-shift)) + regs.DIGG.yShiftIn;

[xnew,x_xaddr,x_yaddr,xnei,xindRow,xIndCol]= bicubicInterp(xLUT,regs.DIGG,xx,yy);%#ok
[ynew,y_xaddr,y_yaddr,ynei,yindRow,yIndCol]= bicubicInterp(yLUT,regs.DIGG,xx,yy);%#ok


% shift + scale out
xnew = int32(bitshift(int64(xnew).*int64(regs.DIGG.xScaleOut),-shift)) + regs.DIGG.xShiftOut;
ynew = int32(bitshift(int64(ynew).*int64(regs.DIGG.yScaleOut),-shift)) + regs.DIGG.yShiftOut;
    
ynew=ynew/2^shift;
xnew=xnew/2^shift;
end


function [val,xaddr,yaddr,neighbors,indRowReal,indColReal]= bicubicInterp(lut,regsDIGG,X,Y)
fx = int64(regsDIGG.undistFx);
fy = int64(regsDIGG.undistFy);
x0 = int64(regsDIGG.undistX0);
y0 = int64(regsDIGG.undistY0);
lut=int64(lut);
shift = int16(regsDIGG.bitshift);
sz = size(X);
XX = int64(X(:)) - x0;
YY = int64(Y(:)) - y0;

xaddr = bitshift(XX*fx,-shift);
yaddr = bitshift(YY*fy,-shift);

assert(all(xaddr>=0 & xaddr<=bitshift(32,shift)-1),'udistort: bad LUT x address');
assert(all(yaddr>=0 & yaddr<=bitshift(32,shift)-1),'udistort: bad LUT y address');

[val,indCol,indRow] = Pipe.DIGG.bicubicFixed(lut, xaddr, yaddr, uint8(shift));
indRowReal = reshape(indRow(:),16,numel(X));
indColReal = reshape(indCol(:),16,numel(X));
neighbors = lut(sub2ind(size(lut),indRowReal(:)+1,indColReal(:)+1));
neighbors = reshape(neighbors,[16 numel(X)])';
val = reshape(val,sz);
%neighbors = reshape(neighbors',[16 sz])';
val=int32(val);
end

