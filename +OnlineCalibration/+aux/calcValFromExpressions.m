function [xCoeff,yCoeff,dXin_dA,dYin_dA] = calcValFromExpressions(deriveByVar,subsParams)
V = subsParams.V';
A = subsParams.rgbPmat;
d = subsParams.d;
Krgb = subsParams.Krgb;
f1 = A*V;
x_in = f1(1,:)./f1(3,:);
y_in = f1(2,:)./f1(3,:);

x1 = (x_in-subsParams.Krgb(1,3))/subsParams.Krgb(1,1);
y1 = (y_in-subsParams.Krgb(2,3))/subsParams.Krgb(2,2);

switch  deriveByVar
    case 'A'
        r2 = x1.^2 + y1.^2;
        Rc = 1+subsParams.d(1,1).*r2+subsParams.d(1,2).*r2.^2+subsParams.d(1,5).*r2.^3;
        xCoeff = [(V(1,:).*(Rc + 6.*d(1,4).*x1 + 2.*d(1,3).*y1 + x1.*(2.*d(1,1).*x1 + 4.*d(1,2).*x1.*(r2) + 6.*d(1,5).*x1.*(r2).^2)))./(A(3,1).*V(1,:) + A(3,2).*V(2,:) + A(3,3).*V(3,:) + A(3,4).*V(4,:)); (V(2,:).*(Rc + 6.*d(1,4).*x1 + 2.*d(1,3).*y1 + x1.*(2.*d(1,1).*x1 + 4.*d(1,2).*x1.*(r2) + 6.*d(1,5).*x1.*(r2).^2)))./(A(3,1).*V(1,:) + A(3,2).*V(2,:) + A(3,3).*V(3,:) + A(3,4).*V(4,:)); (V(3,:).*(Rc + 6.*d(1,4).*x1 + 2.*d(1,3).*y1 + x1.*(2.*d(1,1).*x1 + 4.*d(1,2).*x1.*(r2) + 6.*d(1,5).*x1.*(r2).^2)))./(A(3,1).*V(1,:) + A(3,2).*V(2,:) + A(3,3).*V(3,:) + A(3,4).*V(4,:)); (V(4,:).*(Rc + 6.*d(1,4).*x1 + 2.*d(1,3).*y1 + x1.*(2.*d(1,1).*x1 + 4.*d(1,2).*x1.*(r2) + 6.*d(1,5).*x1.*(r2).^2)))./(A(3,1).*V(1,:) + A(3,2).*V(2,:) + A(3,3).*V(3,:) + A(3,4).*V(4,:));...
            (Krgb(1,1).*V(1,:).*(2.*d(1,3).*x1 + 2.*d(1,4).*y1 + x1.*(2.*d(1,1).*y1 + 4.*d(1,2).*y1.*(r2) + 6.*d(1,5).*y1.*(r2).^2)))./(Krgb(2,2).*(A(3,1).*V(1,:) + A(3,2).*V(2,:) + A(3,3).*V(3,:) + A(3,4).*V(4,:))); (Krgb(1,1).*V(2,:).*(2.*d(1,3).*x1 + 2.*d(1,4).*y1 + x1.*(2.*d(1,1).*y1 + 4.*d(1,2).*y1.*(r2) + 6.*d(1,5).*y1.*(r2).^2)))./(Krgb(2,2).*(A(3,1).*V(1,:) + A(3,2).*V(2,:) + A(3,3).*V(3,:) + A(3,4).*V(4,:))); (Krgb(1,1).*V(3,:).*(2.*d(1,3).*x1 + 2.*d(1,4).*y1 + x1.*(2.*d(1,1).*y1 + 4.*d(1,2).*y1.*(r2) + 6.*d(1,5).*y1.*(r2).^2)))./(Krgb(2,2).*(A(3,1).*V(1,:) + A(3,2).*V(2,:) + A(3,3).*V(3,:) + A(3,4).*V(4,:))); (Krgb(1,1).*V(4,:).*(2.*d(1,3).*x1 + 2.*d(1,4).*y1 + x1.*(2.*d(1,1).*y1 + 4.*d(1,2).*y1.*(r2) + 6.*d(1,5).*y1.*(r2).^2)))./(Krgb(2,2).*(A(3,1).*V(1,:) + A(3,2).*V(2,:) + A(3,3).*V(3,:) + A(3,4).*V(4,:)));...
            - (V(1,:).*(A(1,1).*V(1,:) + A(1,2).*V(2,:) + A(1,3).*V(3,:) + A(1,4).*V(4,:)).*(Rc + 6.*d(1,4).*x1 + 2.*d(1,3).*y1 + x1.*(2.*d(1,1).*x1 + 4.*d(1,2).*x1.*(r2) + 6.*d(1,5).*x1.*(r2).^2)))./(A(3,1).*V(1,:) + A(3,2).*V(2,:) + A(3,3).*V(3,:) + A(3,4).*V(4,:)).^2 - (Krgb(1,1).*V(1,:).*(2.*d(1,3).*x1 + 2.*d(1,4).*y1 + x1.*(2.*d(1,1).*y1 + 4.*d(1,2).*y1.*(r2) + 6.*d(1,5).*y1.*(r2).^2)).*(A(2,1).*V(1,:) + A(2,2).*V(2,:) + A(2,3).*V(3,:) + A(2,4).*V(4,:)))./(Krgb(2,2).*(A(3,1).*V(1,:) + A(3,2).*V(2,:) + A(3,3).*V(3,:) + A(3,4).*V(4,:)).^2); - (V(2,:).*(A(1,1).*V(1,:) + A(1,2).*V(2,:) + A(1,3).*V(3,:) + A(1,4).*V(4,:)).*(Rc + 6.*d(1,4).*x1 + 2.*d(1,3).*y1 + x1.*(2.*d(1,1).*x1 + 4.*d(1,2).*x1.*(r2) + 6.*d(1,5).*x1.*(r2).^2)))./(A(3,1).*V(1,:) + A(3,2).*V(2,:) + A(3,3).*V(3,:) + A(3,4).*V(4,:)).^2 - (Krgb(1,1).*V(2,:).*(2.*d(1,3).*x1 + 2.*d(1,4).*y1 + x1.*(2.*d(1,1).*y1 + 4.*d(1,2).*y1.*(r2) + 6.*d(1,5).*y1.*(r2).^2)).*(A(2,1).*V(1,:) + A(2,2).*V(2,:) + A(2,3).*V(3,:) + A(2,4).*V(4,:)))./(Krgb(2,2).*(A(3,1).*V(1,:) + A(3,2).*V(2,:) + A(3,3).*V(3,:) + A(3,4).*V(4,:)).^2); - (V(3,:).*(A(1,1).*V(1,:) + A(1,2).*V(2,:) + A(1,3).*V(3,:) + A(1,4).*V(4,:)).*(Rc + 6.*d(1,4).*x1 + 2.*d(1,3).*y1 + x1.*(2.*d(1,1).*x1 + 4.*d(1,2).*x1.*(r2) + 6.*d(1,5).*x1.*(r2).^2)))./(A(3,1).*V(1,:) + A(3,2).*V(2,:) + A(3,3).*V(3,:) + A(3,4).*V(4,:)).^2 - (Krgb(1,1).*V(3,:).*(2.*d(1,3).*x1 + 2.*d(1,4).*y1 + x1.*(2.*d(1,1).*y1 + 4.*d(1,2).*y1.*(r2) + 6.*d(1,5).*y1.*(r2).^2)).*(A(2,1).*V(1,:) + A(2,2).*V(2,:) + A(2,3).*V(3,:) + A(2,4).*V(4,:)))./(Krgb(2,2).*(A(3,1).*V(1,:) + A(3,2).*V(2,:) + A(3,3).*V(3,:) + A(3,4).*V(4,:)).^2); - (V(4,:).*(A(1,1).*V(1,:) + A(1,2).*V(2,:) + A(1,3).*V(3,:) + A(1,4).*V(4,:)).*(Rc + 6.*d(1,4).*x1 + 2.*d(1,3).*y1 + x1.*(2.*d(1,1).*x1 + 4.*d(1,2).*x1.*(r2) + 6.*d(1,5).*x1.*(r2).^2)))./(A(3,1).*V(1,:) + A(3,2).*V(2,:) + A(3,3).*V(3,:) + A(3,4).*V(4,:)).^2 - (Krgb(1,1).*V(4,:).*(2.*d(1,3).*x1 + 2.*d(1,4).*y1 + x1.*(2.*d(1,1).*y1 + 4.*d(1,2).*y1.*(r2) + 6.*d(1,5).*y1.*(r2).^2)).*(A(2,1).*V(1,:) + A(2,2).*V(2,:) + A(2,3).*V(3,:) + A(2,4).*V(4,:)))./(Krgb(2,2).*(A(3,1).*V(1,:) + A(3,2).*V(2,:) + A(3,3).*V(3,:) + A(3,4).*V(4,:)).^2)];
        
        yCoeff = [(Krgb(2,2).*V(1,:).*(2.*d(1,3).*x1 + 2.*d(1,4).*y1 + y1.*(2.*d(1,1).*x1 + 4.*d(1,2).*x1.*(r2) + 6.*d(1,5).*x1.*(r2).^2)))./(Krgb(1,1).*(A(3,1).*V(1,:) + A(3,2).*V(2,:) + A(3,3).*V(3,:) + A(3,4).*V(4,:))); (Krgb(2,2).*V(2,:).*(2.*d(1,3).*x1 + 2.*d(1,4).*y1 + y1.*(2.*d(1,1).*x1 + 4.*d(1,2).*x1.*(r2) + 6.*d(1,5).*x1.*(r2).^2)))./(Krgb(1,1).*(A(3,1).*V(1,:) + A(3,2).*V(2,:) + A(3,3).*V(3,:) + A(3,4).*V(4,:))); (Krgb(2,2).*V(3,:).*(2.*d(1,3).*x1 + 2.*d(1,4).*y1 + y1.*(2.*d(1,1).*x1 + 4.*d(1,2).*x1.*(r2) + 6.*d(1,5).*x1.*(r2).^2)))./(Krgb(1,1).*(A(3,1).*V(1,:) + A(3,2).*V(2,:) + A(3,3).*V(3,:) + A(3,4).*V(4,:))); (Krgb(2,2).*V(4,:).*(2.*d(1,3).*x1 + 2.*d(1,4).*y1 + y1.*(2.*d(1,1).*x1 + 4.*d(1,2).*x1.*(r2) + 6.*d(1,5).*x1.*(r2).^2)))./(Krgb(1,1).*(A(3,1).*V(1,:) + A(3,2).*V(2,:) + A(3,3).*V(3,:) + A(3,4).*V(4,:)));...
            (V(1,:).*(Rc + 2.*d(1,4).*x1 + 6.*d(1,3).*y1 + y1.*(2.*d(1,1).*y1 + 4.*d(1,2).*y1.*(r2) + 6.*d(1,5).*y1.*(r2).^2)))./(A(3,1).*V(1,:) + A(3,2).*V(2,:) + A(3,3).*V(3,:) + A(3,4).*V(4,:)); (V(2,:).*(Rc + 2.*d(1,4).*x1 + 6.*d(1,3).*y1 + y1.*(2.*d(1,1).*y1 + 4.*d(1,2).*y1.*(r2) + 6.*d(1,5).*y1.*(r2).^2)))./(A(3,1).*V(1,:) + A(3,2).*V(2,:) + A(3,3).*V(3,:) + A(3,4).*V(4,:));(V(3,:).*(Rc + 2.*d(1,4).*x1 + 6.*d(1,3).*y1 + y1.*(2.*d(1,1).*y1 + 4.*d(1,2).*y1.*(r2) + 6.*d(1,5).*y1.*(r2).^2)))./(A(3,1).*V(1,:) + A(3,2).*V(2,:) + A(3,3).*V(3,:) + A(3,4).*V(4,:)); (V(4,:).*(Rc + 2.*d(1,4).*x1 + 6.*d(1,3).*y1 + y1.*(2.*d(1,1).*y1 + 4.*d(1,2).*y1.*(r2) + 6.*d(1,5).*y1.*(r2).^2)))./(A(3,1).*V(1,:) + A(3,2).*V(2,:) + A(3,3).*V(3,:) + A(3,4).*V(4,:));...
            - (V(1,:).*(A(2,1).*V(1,:) + A(2,2).*V(2,:) + A(2,3).*V(3,:) + A(2,4).*V(4,:)).*(Rc + 2.*d(1,4).*x1 + 6.*d(1,3).*y1 + y1.*(2.*d(1,1).*y1 + 4.*d(1,2).*y1.*(r2) + 6.*d(1,5).*y1.*(r2).^2)))./(A(3,1).*V(1,:) + A(3,2).*V(2,:) + A(3,3).*V(3,:) + A(3,4).*V(4,:)).^2 - (Krgb(2,2).*V(1,:).*(2.*d(1,3).*x1 + 2.*d(1,4).*y1 + y1.*(2.*d(1,1).*x1 + 4.*d(1,2).*x1.*(r2) + 6.*d(1,5).*x1.*(r2).^2)).*(A(1,1).*V(1,:) + A(1,2).*V(2,:) + A(1,3).*V(3,:) + A(1,4).*V(4,:)))./(Krgb(1,1).*(A(3,1).*V(1,:) + A(3,2).*V(2,:) + A(3,3).*V(3,:) + A(3,4).*V(4,:)).^2); - (V(2,:).*(A(2,1).*V(1,:) + A(2,2).*V(2,:) + A(2,3).*V(3,:) + A(2,4).*V(4,:)).*(Rc + 2.*d(1,4).*x1 + 6.*d(1,3).*y1 + y1.*(2.*d(1,1).*y1 + 4.*d(1,2).*y1.*(r2) + 6.*d(1,5).*y1.*(r2).^2)))./(A(3,1).*V(1,:) + A(3,2).*V(2,:) + A(3,3).*V(3,:) + A(3,4).*V(4,:)).^2 - (Krgb(2,2).*V(2,:).*(2.*d(1,3).*x1 + 2.*d(1,4).*y1 + y1.*(2.*d(1,1).*x1 + 4.*d(1,2).*x1.*(r2) + 6.*d(1,5).*x1.*(r2).^2)).*(A(1,1).*V(1,:) + A(1,2).*V(2,:) + A(1,3).*V(3,:) + A(1,4).*V(4,:)))./(Krgb(1,1).*(A(3,1).*V(1,:) + A(3,2).*V(2,:) + A(3,3).*V(3,:) + A(3,4).*V(4,:)).^2); - (V(3,:).*(A(2,1).*V(1,:) + A(2,2).*V(2,:) + A(2,3).*V(3,:) + A(2,4).*V(4,:)).*(Rc + 2.*d(1,4).*x1 + 6.*d(1,3).*y1 + y1.*(2.*d(1,1).*y1 + 4.*d(1,2).*y1.*(r2) + 6.*d(1,5).*y1.*(r2).^2)))./(A(3,1).*V(1,:) + A(3,2).*V(2,:) + A(3,3).*V(3,:) + A(3,4).*V(4,:)).^2 - (Krgb(2,2).*V(3,:).*(2.*d(1,3).*x1 + 2.*d(1,4).*y1 + y1.*(2.*d(1,1).*x1 + 4.*d(1,2).*x1.*(r2) + 6.*d(1,5).*x1.*(r2).^2)).*(A(1,1).*V(1,:) + A(1,2).*V(2,:) + A(1,3).*V(3,:) + A(1,4).*V(4,:)))./(Krgb(1,1).*(A(3,1).*V(1,:) + A(3,2).*V(2,:) + A(3,3).*V(3,:) + A(3,4).*V(4,:)).^2); - (V(4,:).*(A(2,1).*V(1,:) + A(2,2).*V(2,:) + A(2,3).*V(3,:) + A(2,4).*V(4,:)).*(Rc + 2.*d(1,4).*x1 + 6.*d(1,3).*y1 + y1.*(2.*d(1,1).*y1 + 4.*d(1,2).*y1.*(r2) + 6.*d(1,5).*y1.*(r2).^2)))./(A(3,1).*V(1,:) + A(3,2).*V(2,:) + A(3,3).*V(3,:) + A(3,4).*V(4,:)).^2 - (Krgb(2,2).*V(4,:).*(2.*d(1,3).*x1 + 2.*d(1,4).*y1 + y1.*(2.*d(1,1).*x1 + 4.*d(1,2).*x1.*(r2) + 6.*d(1,5).*x1.*(r2).^2)).*(A(1,1).*V(1,:) + A(1,2).*V(2,:) + A(1,3).*V(3,:) + A(1,4).*V(4,:)))./(Krgb(1,1).*(A(3,1).*V(1,:) + A(3,2).*V(2,:) + A(3,3).*V(3,:) + A(3,4).*V(4,:)).^2)];
        
        dXin_dA = [ V(1,:)./(A(3,1).*V(1,:) + A(3,2).*V(2,:) + A(3,3).*V(3,:) + A(3,4).*V(4,:)); V(2,:)./(A(3,1).*V(1,:) + A(3,2).*V(2,:) + A(3,3).*V(3,:) + A(3,4).*V(4,:)); V(3,:)./(A(3,1).*V(1,:) + A(3,2).*V(2,:) + A(3,3).*V(3,:) + A(3,4).*V(4,:)); V(4,:)./(A(3,1).*V(1,:) + A(3,2).*V(2,:) + A(3,3).*V(3,:) + A(3,4).*V(4,:));...
            zeros(1,size(V,2)); zeros(1,size(V,2)); zeros(1,size(V,2)); zeros(1,size(V,2));...
            -(V(1,:).*(A(1,1).*V(1,:) + A(1,2).*V(2,:) + A(1,3).*V(3,:) + A(1,4).*V(4,:)))./(A(3,1).*V(1,:) + A(3,2).*V(2,:) + A(3,3).*V(3,:) + A(3,4).*V(4,:)).^2; -(V(2,:).*(A(1,1).*V(1,:) + A(1,2).*V(2,:) + A(1,3).*V(3,:) + A(1,4).*V(4,:)))./(A(3,1).*V(1,:) + A(3,2).*V(2,:) + A(3,3).*V(3,:) + A(3,4).*V(4,:)).^2; -(V(3,:).*(A(1,1).*V(1,:) + A(1,2).*V(2,:) + A(1,3).*V(3,:) + A(1,4).*V(4,:)))./(A(3,1).*V(1,:) + A(3,2).*V(2,:) + A(3,3).*V(3,:) + A(3,4).*V(4,:)).^2; -(V(4,:).*(A(1,1).*V(1,:) + A(1,2).*V(2,:) + A(1,3).*V(3,:) + A(1,4).*V(4,:)))./(A(3,1).*V(1,:) + A(3,2).*V(2,:) + A(3,3).*V(3,:) + A(3,4).*V(4,:)).^2];
        dYin_dA = [ zeros(1,size(V,2)); zeros(1,size(V,2)); zeros(1,size(V,2)); zeros(1,size(V,2));...
            V(1,:)./(A(3,1).*V(1,:) + A(3,2).*V(2,:) + A(3,3).*V(3,:) + A(3,4).*V(4,:)); V(2,:)./(A(3,1).*V(1,:) + A(3,2).*V(2,:) + A(3,3).*V(3,:) + A(3,4).*V(4,:)); V(3,:)./(A(3,1).*V(1,:) + A(3,2).*V(2,:) + A(3,3).*V(3,:) + A(3,4).*V(4,:));  V(4,:)./(A(3,1).*V(1,:) + A(3,2).*V(2,:) + A(3,3).*V(3,:) + A(3,4).*V(4,:));...
            -(V(1,:).*(A(2,1).*V(1,:) + A(2,2).*V(2,:) + A(2,3).*V(3,:) + A(2,4).*V(4,:)))./(A(3,1).*V(1,:) + A(3,2).*V(2,:) + A(3,3).*V(3,:) + A(3,4).*V(4,:)).^2; -(V(2,:).*(A(2,1).*V(1,:) + A(2,2).*V(2,:) + A(2,3).*V(3,:) + A(2,4).*V(4,:)))./(A(3,1).*V(1,:) + A(3,2).*V(2,:) + A(3,3).*V(3,:) + A(3,4).*V(4,:)).^2; -(V(3,:).*(A(2,1).*V(1,:) + A(2,2).*V(2,:) + A(2,3).*V(3,:) + A(2,4).*V(4,:)))./(A(3,1).*V(1,:) + A(3,2).*V(2,:) + A(3,3).*V(3,:) + A(3,4).*V(4,:)).^2; -(V(4,:).*(A(2,1).*V(1,:) + A(2,2).*V(2,:) + A(2,3).*V(3,:) + A(2,4).*V(4,:)))./(A(3,1).*V(1,:) + A(3,2).*V(2,:) + A(3,3).*V(3,:) + A(3,4).*V(4,:)).^2];
        
    otherwise
        error(['No such sym named ' char(varsInSym(k))]);
end
end